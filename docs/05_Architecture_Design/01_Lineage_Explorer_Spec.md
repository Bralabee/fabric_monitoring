# Fabric Lineage Explorer: Technical Specification

**Version**: 1.0 (Draft)
**Date**: 2026-01-22
**Status**: In Development

## 1. Overview
The **Fabric Lineage Explorer** is a standalone, local-first web application designed to visualize the complex topology of Microsoft Fabric workspaces, items, and external lineages. It replaces static HTML reports with a rich, interactive Graph UI.

## 2. Architecture

### 2.1 Stack
- **Backend (API & Serving)**: Python **FastAPI**.
  - Responsibilities:
    - Parse CSV/Parquet lineage data (generated by `extract_lineage.py`).
    - Transform tabular data into a Graph JSON structure (`nodes` and `edges`).
    - Serve the static frontend assets (HTML/JS/CSS).
    - Provide an API endpoint `/api/graph` for the frontend to fetch data.
- **Frontend (UI)**: **React** (Vite) + **TypeScript**.
  - **Visualization Engine**: **React Flow** (@xyflow/react).
    - *Critical Requirement*: Must use **Sub-Flows** to render Fabric Items nested *inside* Workspace Nodes.
  - **Layout Engine**: **Dagre.js** (or similar) for automatic directed graph layout.
  - **UI Library**: **Tailwind CSS** + **shadcn/ui** (or similar lightweight components).

### 2.2 Data Flow
1.  **Extraction**: User runs `make extract-lineage` -> produces `exports/lineage/*.csv`.
2.  **Launch**: User runs `make explore-lineage`.
3.  **Startup**: Python CLI script starts FastAPI server on `localhost:8000`.
4.  **Loading**:
    - Backend reads the latest CSV.
    - Converts it into `GraphSchema`.
5.  **Interaction**: Browser opens. React app fetches `/api/graph`. React Flow renders the topology.

## 3. Data Model (API Contract)

### 3.1 Graph Schema (JSON)
The API `/api/graph` must return this structure:

```typescript
interface GraphResponse {
  nodes: Node[];
  edges: Edge[];
  meta: {
    generatedAt: string;
    totalWorkspaces: number;
    totalItems: number;
  }
}

interface Node {
  id: string;      // UUID or unique string
  type: string;    // 'workspace' | 'item' | 'externalSource'
  data: {
    label: string;
    metrics?: Record<string, any>; // e.g., { "itemsCount": 5 }
    icon?: string; // URL or icon name
  };
  parentNode?: string; // ID of the parent node (Critical for nesting)
  extent?: 'parent';   // Constrains child to parent bounds
  position: { x: number, y: number };
  style?: React.CSSProperties;
}

interface Edge {
  id: string;
  source: string;
  target: string;
  label?: string; // e.g., "Shortcut", "Mirror"
  animated?: boolean;
  style?: React.CSSProperties; // e.g., { stroke: '#ff0000' }
}
```

## 4. Feature Requirements

### 4.1 "Best in Class" Visualization
1.  **Compound Nodes**: Workspaces must be visual containers. Items (Lakehouses, Warehouses) must appear *inside* them.
2.  **External Sources**: Sources (ADLS, S3, Snowflake) should be *outside* workspaces, acting as hubs connecting different workspaces.
3.  **Minimap**: A navigation corner map for large topologies.
4.  **Controls**: Zoom In/Out, Fit View buttons.

### 4.2 Interactivity
1.  **Node Clicking**: Clicking a node opens a **Side Panel** with detailed metadata (Full Path, Source Connection details, IDs).
2.  **Edge Highlighting**: Hovering an edge highlights the path.
3.  **Filter/Search**: A top bar to search for a specific Workspace or Item name and "fly to" it.
4.  **Table Lineage Panel** (v0.3.25): A side panel showing all Fabric items with:
    - Node-based filtering (click node â†’ filter panel)
    - Search functionality
    - Stats display (Items, Shortcuts, Total)
    - Click-to-focus integration with graph

## 5. Implementation Plan

### Step 1: Backend Scaffold
- Create `src/usf_fabric_monitoring/explorer/`.
- Implement `main.py` (FastAPI app).
- Implement `graph_builder.py` (CSV -> JSON logic).

### Step 2: Frontend Scaffold
- Initialize React app in `src/usf_fabric_monitoring/explorer/frontend`.
- Install dependencies: `reactflow`, `dagre`, `lucide-react`.

### Step 3: Integration
- Build frontend to `dist/`.
- Mount `dist/` as static files in FastAPI.

### Step 4: CLI Entrypoint
- Add `explore_lineage.py` script to launch the server.
- Add `make explore-lineage` target.

---

**Guidance for Agents**:
- Ensure all code is modular.
- Use Type hints in Python.
- Use Interfaces in TypeScript.
- **DO NOT** break existing CSV generation or the static `visualize_lineage.py` script (keep it as a fallback).
